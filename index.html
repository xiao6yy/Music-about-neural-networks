<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Global Wealth Spectrum: Intersecting Views on Taxation, Gender, and
      Industry
    </title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
      rel="stylesheet"
    />

    <style>
      html {
        overflow-x: hidden;
      }
      * {
        margin: 0;
        padding: 0;
        font-family: "sans-serif";
        font-weight: 300;
        margin: 10px;
        background-color: F5F5F5;
        color: #465562;
      }

      .ubuntu-medium {
        font-family: "Ubuntu", sans-serif;
        font-weight: 500;
        font-style: normal;
      }

      h1 {
        font-weight: 800;
        font-family: "Noto Sans";
        font-size: 40px;
        margin-top: 10px;
        color: #465562;
      }

      h3 {
        font-weight: 800;
        font-family: "Noto Sans";
        font-size: 16px;
        margin-top: 10px;
        color: #465562;
      }

      .bubble {
        stroke: #fff;
        stroke-width: 1px;
      }
      .tooltip {
        position: absolute;
        background-color: rgb(55, 55, 55);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        visibility: hidden;
      }

      .tooltip p {
        background-color: rgb(55, 55, 55);
        margin: 0;
        color: whitesmoke;
      }

      .tooltip #countryName {
        font-weight: 600;
      }

      .legend text {
        font-size: 14px;
      }

      .axis line {
        display: none;
      }

      .axis text {
        font-size: 13px;
        color: #465562;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .axis line {
        display: none;
      }

      .grid line {
        stroke: lightgrey;
        stroke-opacity: 0.7;
        shape-rendering: crispEdges;
      }
      .grid path {
        stroke-width: 0;
      }

      .reference {
        font-size: 12px;
      }

      .desc {
        max-width: 70vw;
      }

      .chart-section {
        display: flex;
        gap: 10px;
        justify-content: space-between;
      }
    </style>
  </head>

  <body>
    <h1 class="ubuntu-medium">
      Global Wealth Spectrum: Taxation, Gender, and Industry
    </h1>
    <div class="desc">
      This interactive visualization embarks on a cross-national journey,
      presenting a compelling narrative of how tax policies shape wealth, how
      industries propel fortunes differently across genders, and how these
      forces vary from continent to continent. Engage with our data-driven
      insights to discover the multifaceted layers of global affluence.
    </div>
    <div class="chart-section">
      <div id="chart"></div>
      <div id="bar-chart"></div>
    </div>

    <div class="tooltip"></div>
    <div class="reference">
      <h3>References</h3>

      <p>
        [1] Javier_SAB. (2024, February 24). Billionaires dataset cleaned.
        Kaggle.
        <a
          href="https://www.kaggle.com/datasets/javiersab/billionaires-dataset-cleaned/data "
        >
          https://www.kaggle.com/datasets/javiersab/billionaires-dataset-cleaned/data
        </a>
      </p>
      <p>
        [2] Rosling, H. (n.d.). World Health Chart. Gapminder.<a
          href="https://www.gapminder.org/fw/world-health-chart/"
          >https://www.gapminder.org/fw/world-health-chart/</a
        >
      </p>
    </div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      ;(async () => {
        let bubbleChartData
        const rawData = await d3.csv("data/df_ready.csv")
        const data = rawData.filter(
          (d) => +d.tax_rate <= 100 && +d.tax_rate > 0
        )
        const processedData = data.reduce((accumulator, current) => {
          let {
            country_of_residence,
            wealth,
            life_expectancy,
            age,
            country_pop,
            continent,
            tax_rate,
          } = current
          wealth = +wealth
          country_pop = +country_pop
          age = +age
          tax_rate = +tax_rate

          if (!accumulator[country_of_residence]) {
            accumulator[country_of_residence] = {
              country: country_of_residence,
              total_wealth: 0,
              average_life_expectancy: life_expectancy,
              population: country_pop,
              continent: continent,
              billionaires: 0,
              tax_rate,
            }
          }

          accumulator[country_of_residence].total_wealth += wealth
          accumulator[country_of_residence].billionaires += 1

          return accumulator
        }, {})
        bubbleChartData = Object.values(processedData)

        function drawBubbleChart() {
          // remove old svg element
          d3.select("#chart svg").remove()
          // svg size
          var svgWidth = innerWidth * 0.6,
            svgHeight = innerHeight * 0.65
          var margin = { top: 18, right: 170, bottom: 90, left: 60 }
          var width = svgWidth - margin.left - margin.right
          var height = svgHeight - margin.top - margin.bottom

          var svg = d3
            .select("#chart")
            .append("svg")
            .attr("width", svgWidth)
            .attr("height", svgHeight)
            .append("g")
            .attr(
              "transform",
              "translate(" + margin.left + "," + margin.top + ")"
            )

          svg
            .append("text")
            .attr("x", width / 2 + width / 4)
            .attr("y", height + margin.top - 30)
            .attr("text-anchor", "middle")
            .style("font-size", "1.8vw")
            .text("Bubble Size: Population")
            .style("fill", "#c7ccd0")

          var xTitle = svg
            .append("text")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom - 40)
            .style("text-anchor", "middle")
            .style("font-size", "16px")
            .style("color", "#383e40")
            .text("Total wealth of billionaries (billion US dollars)")

          var yTitle = svg
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left)
            .attr("x", 0 - height / 2)
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .style("font-size", "16px")
            .style("color", "#383e40")
            .text("Tax Rate (%)")

          const customTickValues = [
            31250, 62500, 125000, 250000, 500000, 1000000, 2000000, 4000000,
            8000000,
          ]
          // x axis
          var x = d3
            .scaleSqrt()
            .domain([
              0,
              d3.max(bubbleChartData, function (d) {
                return d.total_wealth
              }),
            ])
            .range([0, width])
            .nice()

          // y axis
          var y = d3
            .scaleLinear()
            .domain([0, d3.max(bubbleChartData, (d) => d.tax_rate)])
            .range([height, 0])

          svg
            .append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).tickFormat((d) => `${d / 1000}`))

          svg.append("g").attr("class", "axis").call(d3.axisLeft(y).ticks(10))

          // grid line
          svg
            .append("g")
            .attr("class", "grid")
            .call(d3.axisLeft(y).tickSize(-width).tickFormat(""))
            .selectAll("line")
            .style("stroke", "lightgrey")
            .style("stroke-opacity", "0.5")

          svg
            .append("g")
            .attr("class", "grid")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).tickSize(-height).tickFormat(""))
            .selectAll("line")
            .style("stroke", "lightgrey")
            .style("stroke-opacity", "0.4")

          // bubble size
          var z = d3
            .scaleSqrt()
            .domain([
              0,
              d3.max(bubbleChartData, function (d) {
                return d.population
              }),
            ])
            .range([8, 60])

          // bubble color
          var color = d3
            .scaleOrdinal(d3.schemeCategory10)
            .domain(bubbleChartData.map((d) => d.continent))

          // legend
          var legendPosition = { x: width + 40, y: height - 200 }

          // add legend to page
          var legend = svg
            .selectAll(".legend")
            .data(color.domain()) // color range
            .enter()
            .append("g")
            .attr("class", "legend")
            .attr("transform", function (d, i) {
              return "translate(0," + i * 5 + ")"
            }) // vertical position of each legend item

          // draw color circle for each legend
          legend
            .append("circle")
            .attr("cx", legendPosition.x)
            .attr("cy", function (d, i) {
              return legendPosition.y + i * 25
            })
            .attr("r", 10)
            .style("fill", color)
            .style("opacity", 0.7)

          // legend text
          legend
            .append("text")
            .attr("x", legendPosition.x + 20)
            .attr("y", function (d, i) {
              return legendPosition.y + i * 25
            })
            .text(function (d) {
              return d
            })
            .style("text-anchor", "start")
            .style("alignment-baseline", "middle")
            .style("color", "#495561")

          // hover and filter
          legend
            .on("mouseover", function (event, selectedContinent) {
              svg.selectAll(".bubble").style("opacity", function (d) {
                return d.continent === selectedContinent ? 0.7 : 0.1
              })

              svg
                .selectAll(".bubble")
                .filter((d) => d.continent === selectedContinent)
                .raise()

              svg
                .selectAll(".legend circle")
                .filter(function (d) {
                  return d === selectedContinent
                })
                .transition()
                .duration(200)
                .attr("r", 12) // Increase radius

              drawIndustryGenderChart(null, selectedContinent)
            })
            .on("mouseout", function (event, selectedContinent) {
              svg.selectAll(".bubble").style("opacity", 0.7)

              svg
                .selectAll(".legend circle")
                .filter(function (d) {
                  return d === selectedContinent
                })
                .transition()
                .duration(200)
                .attr("r", 10) // Return to original radius

              drawIndustryGenderChart()
            })
            .style("cursor", "pointer")

          // draw bubbles
          svg
            .selectAll(".bubble")
            .data(bubbleChartData)
            .enter()
            .append("circle")
            .attr("class", "bubble")
            .attr("cx", function (d) {
              return x(d.total_wealth)
            })
            .attr("cy", function (d) {
              return y(d.tax_rate)
            })
            .attr("r", function (d) {
              return z(d.population)
            })
            .style("fill", function (d) {
              return color(d.continent)
            })
            .style("opacity", 0.7)

          // hover and show tooltip
          var tooltip = d3.select(".tooltip")
          svg
            .selectAll(".bubble")
            .on("mouseover", function (event, d) {
              drawIndustryGenderChart(d.country)

              tooltip
                .style("visibility", "visible")
                .html(
                  "<p id='countryName'>" +
                    d.country +
                    "</p><p>Population: " +
                    (d.population / 1e6).toFixed(2) +
                    " million</p><p>Billionaires Number: " +
                    d.billionaires +
                    "</p><p>Total Wealth: " +
                    d.total_wealth / 1000 +
                    " billion</p><p>Tax Rate: " +
                    d.tax_rate +
                    "%</p>"
                )

              d3.selectAll(".bubble").style("opacity", 0.1)
              d3.select(this).style("opacity", 0.7)

              d3.select(this).style("cursor", "pointer")
            })
            .on("mousemove", function (event, d) {
              tooltip
                .style("top", event.pageY - 10 + "px")
                .style("left", event.pageX + 10 + "px")
            })
            .on("mouseout", function () {
              drawIndustryGenderChart()
              tooltip.style("visibility", "hidden")
              d3.selectAll(".bubble").style("opacity", 0.7)
              d3.select(this).style("cursor", "default")
            })
        }
        drawBubbleChart()

        async function drawIndustryGenderChart(residence, continent) {
          d3.select("#bar-chart svg").remove()
          let processedIndustryData
          let countryData
          console.log({ rawData })
          if (residence) {
            countryData = rawData.filter(
              (d) => d.country_of_residence === residence
            )
          } else if (continent) {
            countryData = rawData.filter((d) => d.continent === continent)
          } else {
            countryData = rawData
          }

          console.log({ countryData })
          let industryData = countryData.reduce((acc, curr) => {
            if (!acc[curr.industry]) {
              acc[curr.industry] = { M: 0, F: 0 }
            }
            acc[curr.industry][curr.gender] += 1
            return acc
          }, {})

          processedIndustryData = Object.keys(industryData).map((industry) => ({
            industry,
            Male: industryData[industry].M,
            Female: industryData[industry].F,
            total: industryData[industry].M + industryData[industry].F,
          }))
          processedIndustryData.sort((a, b) => a.total - b.total)

          // SVG尺寸设置
          let svgWidth = innerWidth * 0.3,
            svgHeight = innerHeight * 0.65
          const margin = { top: 30, right: 150, bottom: 85, left: 40 }
          const width = svgWidth - margin.left - margin.right
          const height = svgHeight - margin.top - margin.bottom

          // 创建SVG容器
          const svg = d3
            .select("#bar-chart")
            .append("svg")
            .attr("width", svgWidth)
            .attr("height", svgHeight)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`)

          // legend
          const genderColors = { Female: "pink", Male: "#759ec7" }
          const legendItems = svg
            .selectAll(".gender-legend")
            .data(Object.entries(genderColors))
            .enter()
            .append("g")
            .attr("transform", (d, i) => `translate(${i * 60}, -30)`) // Adjust positioning

          legendItems
            .append("rect")
            .attr("width", 10)
            .attr("height", 10)
            .attr("fill", (d) => d[1])

          legendItems
            .append("text")
            .attr("x", 15)
            .attr("y", 10)
            .style("font-size", "10px")
            .text((d) => d[0])

          // 创建X和Y比例尺
          const x = d3.scaleLinear().rangeRound([width, 0])
          const y = d3.scaleBand().rangeRound([height, 0]).padding(0.1)

          // 配置比例尺域
          x.domain([0, d3.max(processedIndustryData, (d) => d.Male + d.Female)])
          y.domain(processedIndustryData.map((d) => d.industry))

          // x title
          svg
            .append("text")
            .attr("class", "x axis-title")
            .attr("text-anchor", "middle")
            .attr("x", width / 2)
            .attr("y", height + 50) // Adjust this value to position below the x-axis
            .style("font-size", "16px")
            .text("Billionaires Count")

          // 绘制柱状图
          svg
            .selectAll(".bar")
            .data(processedIndustryData)
            .enter()
            .append("g")
            .attr("transform", (d) => `translate(0, ${y(d.industry)})`)
            .each(function (d) {
              const group = d3.select(this)
              const tooltip = d3.select(".tooltip") // 选择页面上的.tooltip元素

              d3.select(this)
                .style("cursor", "pointer")
                .append("rect")
                .attr("class", "bar")
                .attr("x", x(d.Male))
                .attr("width", width - x(d.Male))
                .attr("height", y.bandwidth() / 2)
                .attr("fill", "#759ec7") // 男性用蓝色表示
                .on("mouseover", function (event) {
                  // 当鼠标悬停时显示tooltip
                  tooltip
                    .style("visibility", "visible")
                    .html(`Male billionaires in ${d.industry}: ${d.Male}`)
                    .style("left", event.pageX + 10 + "px")
                    .style("top", event.pageY + 10 + "px")

                  d3.select(this).attr("fill", "#2c59b7")
                })
                .on("mousemove", function (event, d) {
                  tooltip
                    .style("top", event.pageY - 10 + "px")
                    .style("left", event.pageX + 10 + "px")
                })
                .on("mouseout", function () {
                  // 当鼠标移开时隐藏tooltip
                  tooltip.style("visibility", "hidden")
                  d3.select(this).attr("fill", "#759ec7")
                })

              d3.select(this)
                .append("rect")
                .attr("class", "bar")
                .attr("x", x(d.Male + d.Female))
                .attr("width", x(d.Male) - x(d.Male + d.Female))
                .attr("height", y.bandwidth() / 2)
                .attr("fill", "pink") // 女性用粉色表示
                .on("mouseover", function (event) {
                  // 当鼠标悬停时显示tooltip
                  tooltip
                    .style("visibility", "visible")
                    .html(`Female billionaires in ${d.industry}: ${d.Female}`)
                    .style("left", event.pageX + 10 + "px")
                    .style("top", event.pageY + 10 + "px")

                  d3.select(this).attr("fill", "#ec8582")
                })
                .on("mousemove", function (event, d) {
                  tooltip
                    .style("top", event.pageY - 10 + "px")
                    .style("left", event.pageX + 10 + "px")
                })
                .on("mouseout", function () {
                  // 当鼠标移开时隐藏tooltip
                  tooltip.style("visibility", "hidden")
                  d3.select(this).attr("fill", "pink")
                })
                .style("cursor", "pointer")

              group
                .append("text")
                .attr("x", x(d.Male + d.Female) - 5) // Position text to the left of the bar end
                .attr("y", y.bandwidth() / 4 + 5) // Adjust vertically to align within the bar's height
                .attr("text-anchor", "end") // Right-align text to make it end at the specified x position
                .style("font-size", "12px")
                .style("fill", "#495561") // Set text color
                .text(d.Male + d.Female) // Display the total count
            })
          // .append("text")
          // .attr("x", (d) => x(d.Male + d.Female) + 1) // 在bar的右侧留一点间距
          // .attr("y", (d) => y(d.industry) + y.bandwidth()) // 调整文本的垂直位置使其居中
          // .text((d) => d.Male + d.Female)
          // .style("font-size", "12px")
          // .style("fill", "#B0B0B0") // 浅灰色
          const maxValue = d3.max(
            processedIndustryData,
            (d) => d.Male + d.Female
          )

          const calculateTickValues = (maxValue) => {
            let stepSize
            if (maxValue <= 5) {
              stepSize = 1
            } else if (maxValue <= 50) {
              stepSize = 5
            } else {
              stepSize = 50
            }

            const tickValues = []
            for (let i = 0; i <= maxValue; i += stepSize) {
              tickValues.push(i)
            }

            // Ensure the last tick value is greater than maxValue if not already included
            if (maxValue - tickValues[tickValues.length - 1] > stepSize / 2) {
              tickValues.push(
                d3.max(processedIndustryData, (d) => d.Male + d.Female)
              )
            }

            return tickValues
          }

          const tickValues = calculateTickValues(maxValue)
          // 添加X轴和Y轴
          svg
            .append("g")
            .attr("class", "x axis")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).tickValues(tickValues))

          svg
            .append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + width + ", 0)")
            .call(d3.axisRight(y))
            .selectAll(".tick text")
            .attr("dy", "-1px") // 设置dy属性
        }
        drawIndustryGenderChart()

        window.addEventListener(
          "resize",
          debounce(function () {
            drawBubbleChart()
            drawIndustryGenderChart()
          }, 250)
        )

        function debounce(func, wait, immediate) {
          var timeout
          return function () {
            var context = this,
              args = arguments
            clearTimeout(timeout)
            timeout = setTimeout(function () {
              timeout = null
              if (!immediate) func.apply(context, args)
            }, wait)
            if (immediate && !timeout) func.apply(context, args)
          }
        }
      })()
    </script>
  </body>
</html>
